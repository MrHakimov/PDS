\section{Слабые модели консистентности. Мотивация, чтение собственных записей.}

\begin{remark}
    Репликация с точки зрения \textit{CAP}-теоремы:
    \begin{itemize}
        \item Синхронная репликация --- это $C$-протокол.
        \item Асинхронная репликация (без \textit{Failover}) не является ни $C$-, ни $A$-протоколом.
        \begin{itemize}
            \item Доступности нет, потому что в случае падения лидера не можем обслуживать запросы на запись.
            \item Но зато есть частичная доступность, так как продолжаем принимать запросы на чтение.
            \item Консистентности нет, потому что возможны нелиаризуемые исполнения.
            \item Зато есть \textit{Eventual Consistency}, так как в отсутствие записей каждая реплика в конечном итоге получит весь журнал.
        \end{itemize}
    \end{itemize}
\end{remark}

\begin{example}{Нелинеаризуемое исполнение}
    Лидер ответил ОК на запись, клиент прочитал не то значение с реплики, потому что репликация записи ещё не произошла.
\end{example}

\begin{definition}
    \textit{Слабые модели консистентности:}
    \begin{itemize}
        \item Не запрещают все нелинеаризуемые исполнения, так как это приведет к потере доступности.
        \item Но запрещают некоторые исполенения, которые могут отрицательно повлиять на пользовательский опыт.
        \item Какие именно исполнения запретить и как их избегать зависит от самой модели.
    \end{itemize}

\end{definition}

\begin{example}(Чтение собственных записей)

     Хотим, чтобы если клиент сделал какое-то изменение, то при дальнейших запросах на чтение он видел результат этого изменения. Есть два подхода к реализации такой слабой модели консистентности:
    \begin{itemize}
        \item \textit{Чтение из лидера:}
        \begin{itemize}
            \item Представим, что в нашей системе пользователи могут менять только свои данные (таких данных мало) и читать чужие данные (их много).
            \item Тогда будем читать свои данные с лидера, а чужие с реплик.
            \item Таким образом, мы всегда будем читать актуальные собственные записи.
            \item Примеры таких систем: сайты с объявлениями, профили в социальных сетях.
        \end{itemize}

        \item \textit{Запоминание номера записи:}
        \begin{itemize}
            \item После того, как клиент отправляет запрос на запись, он получает подтверждение и номер этой записи в журнале лидера, которой соответствует исполененная транзакция.
            \item Клиент запоминает полученный номер у себя.
            \item Вместе с запросом на чтение клиент запрашивает у реплики номер последней записи в ее журнале.
            \item Реплика в ответ посылает номер своей последней записи в журнале и ответ на запрос.
            \item Если номер, полученный от реплики, меньше сохраненного у клиента, то это значит, что запись не успела отреплицироваться. Поэтому делаем запрос на чтение следующей реплике.
            \item Если номер, полученный от реплики, не меньше сохраненного у клиента, то возьмем ее ответ на запрос и больше не будем спрашивать другие реплик.
        \end{itemize}

    \end{itemize}

\end{example}
