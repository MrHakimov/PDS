\section{Gossip. СRDT и дельта-CRDT, примеры со счетчиком, множеством.}

\textit{Gossip и базовые определения читайте в предыдущем билете.}

\begin{definition}
    \textit{CRDT} оперирует состоянием системы.
    \textit{Операция} в системе задается состоянием $x$,
    в которое система переходит при применении этой операции
    к начальному состоянию $s_0$.
\end{definition}

\begin{definition}
    Операция \textit{объединения} (merge) для состояний
    после нескольких операций:
    \begin{itemize}
        \item $x$ --- состояние после применения операции $x_{op}$.
        \item $y$ --- состояние после применения операции $y_{op}$.
        \item $x \sqcup y$ --- состояние после объединения состояний $x$ и $y$.
    \end{itemize}
\end{definition}

\begin{definition}
    Множество состояний системы образует \textit{полурешетку} ---
    полугруппа с коммутативной и идемпотентной
    операцией \textit{объединения} состояний:
    \begin{itemize}
        \item \textit{Коммутативность}: $x \sqcup y = y \sqcup x$
            \begin{itemize}
                \item Порядок операций не важен.
                \item Не нужен \textit{total order}, т.е. консенсус по поводу
                    того в каком порядке операции происходили на разных узлах.
            \end{itemize}
        \item \textit{Идемпотентность}: $x \sqcup x = x$
            \begin{itemize}
                \item Повторное применение операции не меняет состояние.
                \item Поэтому не нужна \textit{reliable} доставка, то есть
                    \textit{exactly once delivery}.
            \end{itemize}
        \item \textit{Полугруппа (ассоциативность)}:
            $x \sqcup y \sqcup z = x \sqcup (y \sqcup z)$
            можно объединять операции в любом порядке.
    \end{itemize}
\end{definition}

\begin{example}
    \textit{CRDT} --- Увеличивающийся счётчик.
    Вариант с \textit{операциями}:

    \begin{itemize}
        \item \textit{Операция}: Добавить $x$ к значению счётчика.
        \item \textit{Состояние}: Множество операций.
        \item В данном случае $\sqcup = \cup$, следовательно
            объединение \textit{коммутативно}.
        \item По множеству операций возможно восстановить значение.
        \item Нужно чтобы у всех участников было общее мнение о
            множестве проведённых операций. В случае сбоя множества
            могут быть разными. Используем \textit{gossip} для восстановления.
        \item \textit{Идемпотентность} получим, добавив уникальной
            идентификатор каждой операции.
    \end{itemize}
\end{example}

\begin{remark}
    Предыдущий пример не масштабируется по числу операций.
\end{remark}

\begin{example}
    \textit{CRDT} --- Увеличивающийся счётчик.
    Вариант с \textit{состоянием}:

    \begin{itemize}
        \item \textit{Операция}: Добавить $x$ к значению счётчика.
        \item \textit{Физическое состояние}: Вектор размером в число узлов.
            (каждый узел увеличивает свою компоненту).
        \item \textit{Логическое состояние}: сумма элементов вектора
        \item \textit{Объединение}: Покомпонентный $\max$.
            Это \textit{коммутативная} и \textit{идемпотентная} операция.
            Но важно, что счётчик только растет.
        \item Рассылаем через \textit{gossip} текущее известное состояние.
            Размер состояния фиксирован, но надо пересылать $\cO(n)$ значений.
    \end{itemize}
\end{example}

\begin{definition}
    $\delta$\textit{-CRDT} --- это \textit{CRDT} на основе состояний, где пересылается не
    все целиком, а только отличие состояния от предыдущего.
\end{definition}

\begin{example}
    \enewline
    \begin{itemize}
        \item Счётчик: если узел $i$ увеличивает счётчик, то пересылаем не весь вектор,
            а только отображение $\{i \to x_i\}$.
        \item Операция \textit{merge} это объединение отображений и покомпонентный максимум.
        \item Каждому соседу надо посылать только изменения по сравнению с предыдущим посланным
            сообщением, т.е. только значения изменившихся значений в отображении.
        \item \textit{Итого:} в стабильной системе одна операция вызывает распространение
            сообщения размером.
    \end{itemize}
\end{example}

\begin{examples} \textit{Множества:}
    \begin{itemize}
        \item \textit{Растущее множество:} аналогично счётчику, операцией слияния будет
            объединение множеств (можно передавать дельты изменений, вместо самих множеств).
        \item \textit{Множество с операций удаления}: разделим на множество добавленных и
            удалённых элементов. Но множество удаленных элементов растет вечно. На практике
            удалённые элементы выкидывают через определённый промежуток времени.
    \end{itemize}
\end{examples}
