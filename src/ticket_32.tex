\section{Транзакции в распределенных системах. ACID. 2 Phase Locking.}

\begin{definition}
    \textit{Транзакция} это единица работы над множеством элементов,
    хранящихся в базе данных.
\end{definition}

\begin{definition} \textit{ACID:}
    \begin{itemize}
        \item \textit{Atomicity} (атомарность) –- все изменения или ничего.
        \item \textit{Consistency} (согласованность) –- перевод системы в согласованное
            состояние в конце транзакции.
        \item \textit{Isolation} (изолированность) –- параллельные транзакции не
            должны влиять друг на друга, а выполняться как будто бы
            последовательно.
        \item \textit{Durability} (надежность) –- завершенные транзакции сохраняются
            даже в случае сбоев и перезапуска системы.
    \end{itemize}
\end{definition}

\begin{algorithm} \textit{Подходы к сохранению Atomicity:}
    \begin{itemize}
        \item \textbf{Подход 1}. Храним <<собственную версию>> данных в рамках транзакции (shadow copy):
            \begin{itemize}
                \item Не делаем изменения основной копии до завершения (commit) транзакции.
                \item Откидываем свою копию её если транзакция откатывается.
                \item Получается \textit{Redo log} –- журнал изменений которые надо
                    применить только в случае завершения транзакции.
            \end{itemize}
        \item \textbf{Подход 2}. Храним <<журнал отката>>:
            \begin{itemize}
                \item Вносим изменения в основную копию.
                \item \textit{Undo log} –- запоминаем журнал по которому можно отменить
                    (undo) все произведённые в транзакции изменения.
                \item Если надо транзакцию откатить, то применяем undo log чтобы
                    отменить внесённые изменения.
            \end{itemize}
    \end{itemize}
\end{algorithm}

\begin{algorithm} \textit{Подходы к сохранению Durability:}
    \begin{itemize}
        \item Либо все изменения исходных данных записаны в энергонезависимую (non-volatile) память.
        \item Либо \textit{redo log} записан в энергонезависимую память
            (более популярно, т.к. это последовательный журнал, который проще писать на диск).
    \end{itemize}
\end{algorithm}

\begin{definition}
    Максимальный \textit{уровень изоляции} (isolation) level называется
    \textit{сериализуемость} (serializability) –- все транзакции можно переупорядочить в
    последовательную историю исполнения, так чтобы никакие две транзакции не выполнялись параллельно.
\end{definition}

\begin{definition} \textit{2-Phase Locking:}
    \begin{itemize}
        \item Каждая транзакция состоит из 2-х последовательных фаз –-
            фаза получения блокировок и фаза отпускания блокировок.
        \item Блокировки могут браться и отпускать в любом порядке в
            соответствующих фазах, при условии что каждая операция над
            элементом данных происходит после получения соответствующей ему блокировки и до её отпускания.
    \end{itemize}
\end{definition}

\begin{remark}
    2PL исполнение гарантирует сериализуемость транзакции.
\end{remark}

\begin{remark}
    Блокировка может быть решена локально каждым узлом (распределённые алгоритмы блокировки на нужны!)
\end{remark}

\begin{example}
    \enewline
    \begin{itemize}
        \item Участник $P$ решил что транзакция завершилась успешно (commit)
            и сохранил все изменения перед опускание блокировок, сделав
            их видимыми другим участникам.
        \item Участник $Q$ решил что транзакция завершилась неуспешно
            (rollback) и отменил все изменения перед опусканием блокировок.
        \item \textit{Нарушена атомарность} транзакции. Способы решения в следующем билете.
    \end{itemize}
\end{example}

